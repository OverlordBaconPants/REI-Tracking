{% extends "base.html" %}

{% block title %}Add Properties{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Add Properties</li>
{% endblock %}

{% block head %}
{{ super() }}
<style>
    #autocomplete-results {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
    }
    #autocomplete-results div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff; 
        border-bottom: 1px solid #d4d4d4; 
    }
    #autocomplete-results div:hover {
        background-color: #e9e9e9; 
    }
    .autocomplete-container {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Add Properties</h2>
    <form method="POST">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3 autocomplete-container">
                    <label for="property_address">Property Address</label>
                    <input type="text" class="form-control" id="property_address" name="property_address" required>
                    <div id="autocomplete-results"></div>
                </div>
                <div class="form-group mb-3">
                    <label for="purchase_price">Purchase Price ($)</label>
                    <input type="number" class="form-control" id="purchase_price" name="purchase_price" placeholder="Enter Whole Dollar Amount" required>
                </div>
                <div class="form-group mb-3">
                    <label for="down_payment">Down Payment ($)</label>
                    <input type="number" class="form-control" id="down_payment" name="down_payment" placeholder="Enter Whole Dollar Amount" required>
                </div>
                <div class="form-group mb-3">
                    <label for="primary_loan_rate">Primary Loan Interest Rate (%)</label>
                    <input type="number" step="0.01" class="form-control" id="primary_loan_rate" name="primary_loan_rate" placeholder="Enter Interest Rate to Two Decimal Places" required>
                </div>
                <div class="form-group mb-3">
                    <label for="primary_loan_term">Primary Loan Term (months)</label>
                    <input type="number" class="form-control" id="primary_loan_term" name="primary_loan_term" placeholder="Enter Loan Term in Months" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label for="seller_financing_amount">Seller Financing Amount ($)</label>
                    <input type="number" class="form-control" id="seller_financing_amount" name="seller_financing_amount" placeholder="If Applicable, Enter Amount of Seller Financing. Otherwise, Leave Blank">
                </div>
                <div class="form-group mb-3">
                    <label for="seller_financing_rate">Seller Financing Rate (%)</label>
                    <input type="number" step="0.01" class="form-control" id="seller_financing_rate" name="seller_financing_rate" placeholder="If Applicable, Enter Interest Rate to Two Decimal Places">
                </div>
                <div class="form-group mb-3">
                    <label for="closing_costs">Closing Costs ($)</label>
                    <input type="number" class="form-control" id="closing_costs" name="closing_costs" placeholder="Enter Whole Dollar Amount" required>
                </div>
                <div class="form-group mb-3">
                    <label for="renovation_costs">Renovation Costs ($)</label>
                    <input type="number" class="form-control" id="renovation_costs" name="renovation_costs" placeholder="Enter Whole Dollar Amount" required>
                </div>
                <div class="form-group mb-3">
                    <label for="marketing_costs">Marketing Costs ($)</label>
                    <input type="number" class="form-control" id="marketing_costs" name="marketing_costs" placeholder="Enter Whole Dollar Amount" required>
                </div>
                <div class="form-group mb-3">
                    <label for="holding_costs">Holding Costs ($)</label>
                    <input type="number" class="form-control" id="holding_costs" name="holding_costs" placeholder="Enter Whole Dollar Amount" required>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Add Property</button>
        <button type="reset" class="btn btn-secondary mt-3">Reset Form</button>
    </form>
</div>

<link rel="stylesheet" href="https://cdn.geoapify.com/geocoder-autocomplete/v1.5.1/styles/minimal.css">

 <!-- Debug output -->
 <script>
    const addressInput = document.getElementById('property_address');
    const resultsContainer = document.getElementById('autocomplete-results');
    const apiKey = '{{ config["GEOAPIFY_API_KEY"] }}';
    
    let debounceTimer;
    
    addressInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = this.value;
            if (query.length > 2) {
                fetchAddresses(query);
            } else {
                resultsContainer.innerHTML = '';
            }
        }, 300);
    });
    
    function fetchAddresses(query) {
        const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&apiKey=${apiKey}`;
        
        fetch(url)
            .then(response => response.json())
            .then(result => {
                displayResults(result.features);
            })
            .catch(error => console.log('error', error));
    }
    
    function displayResults(features) {
        resultsContainer.innerHTML = '';
        features.forEach(feature => {
            const div = document.createElement('div');
            div.textContent = feature.properties.formatted;
            div.addEventListener('click', function() {
                addressInput.value = feature.properties.formatted;
                resultsContainer.innerHTML = '';
            });
            resultsContainer.appendChild(div);
        });
    }
    
    // Close the autocomplete list when clicking outside of it
    document.addEventListener('click', function(e) {
        if (e.target !== addressInput && e.target !== resultsContainer) {
            resultsContainer.innerHTML = '';
        }
    });
    </script>
{% endblock %}