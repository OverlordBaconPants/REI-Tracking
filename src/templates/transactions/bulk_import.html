{% extends "base.html" %}

{% block title %}Bulk Import Transactions{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Bulk Import Transactions</h4>
                </div>
                <div class="card-body p-3">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        After selecting a file to upload, we'll walk you through mapping your columns to the fields we expect.
                    </div>

                    <div id="import-steps">
                        <!-- Step 1: File Selection -->
                        <div id="step-1" class="import-step active">
                            <h5>Step 1: Select File</h5>
                            <form id="file-upload-form" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="file" class="form-label">Select CSV or Excel file</label>
                                    <input type="file" 
                                           class="form-control" 
                                           id="file" 
                                           name="file" 
                                           accept=".csv,.xls,.xlsx">
                                    <div class="form-text">Supported formats: CSV, XLS, XLSX</div>
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                                    <button type="submit" class="btn btn-primary" id="upload-button">
                                        <i class="bi bi-upload me-2"></i>Upload File
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 2: Column Mapping -->
                        <div id="step-2" class="import-step d-none">
                            <h5>Step 2: Map Columns</h5>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Required fields:</strong> Property, Amount, and Date are required for each transaction.
                            </div>
                            <form id="column-mapping-form">
                                <div id="column-mapping-container" class="mb-3">
                                    <!-- Column mapping will be dynamically inserted here -->
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                    <button type="button" class="btn btn-secondary" id="back-to-step-1">
                                        <i class="bi bi-arrow-left me-2"></i>Back
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="map-columns-button">
                                        <i class="bi bi-check2 me-2"></i>Map Columns
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 3: Preview & Import -->
                        <div id="step-3" class="import-step d-none">
                            <h5>Step 3: Preview & Import</h5>
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Review the preview below and click Import to process all rows.
                            </div>
                            
                            <div id="preview-container" class="mb-4">
                                <h6>Data Preview (first 5 rows):</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-hover" id="preview-table">
                                        <thead>
                                            <tr>
                                                <th>Property</th>
                                                <th>Type</th>
                                                <th>Category</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Collector/Payer</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Preview data will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <button type="button" class="btn btn-secondary" id="back-to-step-2">
                                    <i class="bi bi-arrow-left me-2"></i>Back
                                </button>
                                <button type="button" class="btn btn-success" id="import-button">
                                    <i class="bi bi-file-earmark-arrow-down me-2"></i>Import All
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Results -->
                        <div id="step-4" class="import-step d-none">
                            <h5>Step 4: Import Results</h5>
                            <div id="results-container">
                                <!-- Results will be inserted here -->
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                <button type="button" class="btn btn-primary" id="view-transactions-button">
                                    <i class="bi bi-table me-2"></i>View Transactions
                                </button>
                                <button type="button" class="btn btn-secondary" id="import-more-button">
                                    <i class="bi bi-plus-circle me-2"></i>Import More
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const fileUploadForm = document.getElementById('file-upload-form');
    const columnMappingForm = document.getElementById('column-mapping-form');
    const columnMappingContainer = document.getElementById('column-mapping-container');
    const previewTable = document.getElementById('preview-table');
    const resultsContainer = document.getElementById('results-container');
    
    // Step navigation
    const steps = document.querySelectorAll('.import-step');
    const backToStep1Button = document.getElementById('back-to-step-1');
    const backToStep2Button = document.getElementById('back-to-step-2');
    const importButton = document.getElementById('import-button');
    const viewTransactionsButton = document.getElementById('view-transactions-button');
    const importMoreButton = document.getElementById('import-more-button');
    
    // Store data
    let fileColumns = [];
    let columnMapping = {};
    let previewData = [];
    
    // Show a specific step
    function showStep(stepNumber) {
        steps.forEach((step, index) => {
            if (index + 1 === stepNumber) {
                step.classList.remove('d-none');
            } else {
                step.classList.add('d-none');
            }
        });
    }
    
    // Handle file upload
    fileUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('file');
        if (!fileInput.files.length) {
            alert('Please select a file to upload');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        // Show loading state
        const uploadButton = document.getElementById('upload-button');
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
        
        // Send request to get columns
        fetch('/api/transactions/bulk-import/get-columns', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fileColumns = data.columns;
                createColumnMappingForm(fileColumns);
                showStep(2);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing the file');
        })
        .finally(() => {
            // Reset button state
            uploadButton.disabled = false;
            uploadButton.innerHTML = '<i class="bi bi-upload me-2"></i>Upload File';
        });
    });
    
    // Create column mapping form
    function createColumnMappingForm(columns) {
        columnMappingContainer.innerHTML = '';
        
        // Create field mappings
        const fields = [
            { name: 'property_id', label: 'Property', required: true },
            { name: 'amount', label: 'Amount', required: true },
            { name: 'date', label: 'Date', required: true },
            { name: 'category', label: 'Category', required: false },
            { name: 'description', label: 'Description', required: false },
            { name: 'collector_payer', label: 'Collector/Payer', required: false }
        ];
        
        fields.forEach(field => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'mb-3';
            
            const label = document.createElement('label');
            label.className = 'form-label';
            label.htmlFor = `mapping-${field.name}`;
            label.innerHTML = `Map ${field.label} to: ${field.required ? '<span class="text-danger">*</span>' : ''}`;
            
            const select = document.createElement('select');
            select.className = 'form-select';
            select.id = `mapping-${field.name}`;
            select.name = field.name;
            
            // Add empty option
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = `-- Select column for ${field.label} --`;
            select.appendChild(emptyOption);
            
            // Add column options
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                
                // Try to auto-map columns based on common names
                if (field.name === 'property_id' && 
                    column.toLowerCase().includes('property')) {
                    option.selected = true;
                } else if (field.name === 'amount' && 
                          (column.toLowerCase().includes('amount') || 
                           column.toLowerCase().includes('price'))) {
                    option.selected = true;
                } else if (field.name === 'date' && 
                          (column.toLowerCase().includes('date'))) {
                    option.selected = true;
                } else if (field.name === 'category' && 
                          (column.toLowerCase().includes('category'))) {
                    option.selected = true;
                } else if (field.name === 'description' && 
                          (column.toLowerCase().includes('description') || 
                           column.toLowerCase().includes('desc'))) {
                    option.selected = true;
                } else if (field.name === 'collector_payer' && 
                          (column.toLowerCase().includes('collector') || 
                           column.toLowerCase().includes('payer') ||
                           column.toLowerCase().includes('paid by'))) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
            
            const helpText = document.createElement('div');
            helpText.className = 'form-text';
            helpText.textContent = field.required ? 
                'This field is required' : 
                'This field is optional';
            
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(select);
            fieldDiv.appendChild(helpText);
            
            columnMappingContainer.appendChild(fieldDiv);
        });
    }
    
    // Handle column mapping form submission
    columnMappingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get column mapping
        columnMapping = {};
        const requiredFields = ['property_id', 'amount', 'date'];
        let missingRequired = false;
        
        requiredFields.forEach(field => {
            const select = document.getElementById(`mapping-${field}`);
            if (!select.value) {
                missingRequired = true;
                select.classList.add('is-invalid');
            } else {
                select.classList.remove('is-invalid');
                columnMapping[field] = select.value;
            }
        });
        
        // Check optional fields
        ['category', 'description', 'collector_payer'].forEach(field => {
            const select = document.getElementById(`mapping-${field}`);
            if (select.value) {
                columnMapping[field] = select.value;
            }
        });
        
        if (missingRequired) {
            alert('Please map all required fields');
            return;
        }
        
        // Show loading state
        const mapButton = document.getElementById('map-columns-button');
        mapButton.disabled = true;
        mapButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        
        // Get file again
        const fileInput = document.getElementById('file');
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('column_mapping', JSON.stringify(columnMapping));
        
        // Send request to preview data
        fetch('/api/transactions/bulk-import', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Store preview data
                previewData = data.results.preview_data || [];
                
                // Populate preview table
                populatePreviewTable(previewData);
                
                // Show step 3
                showStep(3);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing the data');
        })
        .finally(() => {
            // Reset button state
            mapButton.disabled = false;
            mapButton.innerHTML = '<i class="bi bi-check2 me-2"></i>Map Columns';
        });
    });
    
    // Populate preview table
    function populatePreviewTable(data) {
        const tbody = previewTable.querySelector('tbody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 7;
            cell.textContent = 'No preview data available';
            cell.className = 'text-center';
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
        }
        
        data.forEach(item => {
            const row = document.createElement('tr');
            
            // Add cells
            row.innerHTML = `
                <td>${item.property_id}</td>
                <td>${item.type}</td>
                <td>${item.category}</td>
                <td>${item.description}</td>
                <td>${item.amount}</td>
                <td>${item.date}</td>
                <td>${item.collector_payer}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // Handle import button click
    importButton.addEventListener('click', function() {
        // Show loading state
        importButton.disabled = true;
        importButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Importing...';
        
        // Get file again
        const fileInput = document.getElementById('file');
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('column_mapping', JSON.stringify(columnMapping));
        
        // Send request to import data
        fetch('/api/transactions/bulk-import', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show results
                displayResults(data.results);
                
                // Show step 4
                showStep(4);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while importing the data');
        })
        .finally(() => {
            // Reset button state
            importButton.disabled = false;
            importButton.innerHTML = '<i class="bi bi-file-earmark-arrow-down me-2"></i>Import All';
        });
    });
    
    // Display import results
    function displayResults(results) {
        resultsContainer.innerHTML = '';
        
        // Create results summary
        const summary = document.createElement('div');
        summary.className = 'alert alert-success';
        summary.innerHTML = `
            <h6>Import Summary:</h6>
            <ul>
                <li>Total rows in file: ${results.total_rows}</li>
                <li>Successfully processed: ${results.processed_rows}</li>
                <li>Successfully imported: ${results.imported_count}</li>
                <li>Skipped rows: ${results.skipped_rows}</li>
            </ul>
        `;
        
        resultsContainer.appendChild(summary);
        
        // Add details about skipped rows if any
        if (results.skipped_rows > 0) {
            const skippedDetails = document.createElement('div');
            skippedDetails.className = 'alert alert-warning';
            
            let skippedHtml = '<h6>Skipped Rows Details:</h6><ul>';
            for (const [reason, count] of Object.entries(results.skipped_details)) {
                if (count > 0) {
                    skippedHtml += `<li>${reason.replace('_', ' ')}: ${count}</li>`;
                }
            }
            skippedHtml += '</ul>';
            
            skippedDetails.innerHTML = skippedHtml;
            resultsContainer.appendChild(skippedDetails);
        }
        
        // Add modifications if any
        if (results.modifications && results.modifications.length > 0) {
            const modificationsDiv = document.createElement('div');
            modificationsDiv.className = 'mt-3';
            
            modificationsDiv.innerHTML = `
                <h6>Modifications:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Row</th>
                                <th>Field</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.modifications.map(mod => `
                                <tr>
                                    <td>${mod.row}</td>
                                    <td>${mod.field}</td>
                                    <td>${mod.message}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            resultsContainer.appendChild(modificationsDiv);
        }
    }
    
    // Navigation buttons
    backToStep1Button.addEventListener('click', () => showStep(1));
    backToStep2Button.addEventListener('click', () => showStep(2));
    viewTransactionsButton.addEventListener('click', () => window.location.href = '/api/transactions');
    importMoreButton.addEventListener('click', () => {
        // Reset forms and go back to step 1
        fileUploadForm.reset();
        columnMappingForm.reset();
        showStep(1);
    });
});
</script>
{% endblock %}
