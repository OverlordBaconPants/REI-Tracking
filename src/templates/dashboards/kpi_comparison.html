{% extends "base.html" %}
{% block title %}KPI Comparison Tool{% endblock %}
{% block body_class %}kpi-comparison-page{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mt-3">
                <div class="card-header bg-navy">
                    <h4 class="mb-0 text-white">KPI Comparison Tool</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="property-selector">Select Property</label>
                                <select class="form-control" id="property-selector">
                                    <option value="">-- Select Property --</option>
                                    {% for property in properties %}
                                    <option value="{{ property.id }}">{{ property.address }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="analysis-selector">Select Analysis</label>
                                <select class="form-control" id="analysis-selector" disabled>
                                    <option value="">-- Select Analysis --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="start-date">Start Date (Optional)</label>
                                <input type="date" class="form-control" id="start-date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="end-date">End Date (Optional)</label>
                                <input type="date" class="form-control" id="end-date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button id="generate-report-btn" class="btn btn-primary" disabled>
                                <i class="bi bi-file-pdf me-2"></i>Generate KPI Comparison Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div id="comparison-preview" class="d-none">
                                <h5 class="mb-3">Comparison Preview</h5>
                                
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Monthly Income & Expenses</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-sm">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Metric</th>
                                                                <th>Projected</th>
                                                                <th>Actual</th>
                                                                <th>Variance</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>Monthly Income</td>
                                                                <td id="projected-income">$0.00</td>
                                                                <td id="actual-income">$0.00</td>
                                                                <td id="income-variance">$0.00 (0%)</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Monthly Expenses</td>
                                                                <td id="projected-expenses">$0.00</td>
                                                                <td id="actual-expenses">$0.00</td>
                                                                <td id="expenses-variance">$0.00 (0%)</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-sm">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Metric</th>
                                                                <th>Projected</th>
                                                                <th>Actual</th>
                                                                <th>Variance</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>Monthly NOI</td>
                                                                <td id="projected-noi">$0.00</td>
                                                                <td id="actual-noi">$0.00</td>
                                                                <td id="noi-variance">$0.00 (0%)</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Monthly Cash Flow</td>
                                                                <td id="projected-cashflow">$0.00</td>
                                                                <td id="actual-cashflow">$0.00</td>
                                                                <td id="cashflow-variance">$0.00 (0%)</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Investment Metrics</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-sm">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Metric</th>
                                                        <th>Projected</th>
                                                        <th>Actual</th>
                                                        <th>Variance</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>Cap Rate</td>
                                                        <td id="projected-cap-rate">0.00%</td>
                                                        <td id="actual-cap-rate">0.00%</td>
                                                        <td id="cap-rate-variance">0.00% (0%)</td>
                                                        <td id="cap-rate-status">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Cash on Cash Return</td>
                                                        <td id="projected-coc">0.00%</td>
                                                        <td id="actual-coc">0.00%</td>
                                                        <td id="coc-variance">0.00% (0%)</td>
                                                        <td id="coc-status">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td>DSCR</td>
                                                        <td id="projected-dscr">0.00</td>
                                                        <td id="actual-dscr">0.00</td>
                                                        <td id="dscr-variance">0.00 (0%)</td>
                                                        <td id="dscr-status">-</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mt-4">
                                    <p class="mb-0"><strong>Note:</strong> This is a preview of the comparison data. Generate the PDF report for a comprehensive analysis with visualizations.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const propertySelector = document.getElementById('property-selector');
    const analysisSelector = document.getElementById('analysis-selector');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const comparisonPreview = document.getElementById('comparison-preview');
    
    // Format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2
        }).format(amount);
    }
    
    // Format percentage
    function formatPercentage(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'percent',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value / 100);
    }
    
    // Format decimal
    function formatDecimal(value) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }
    
    // Update analysis selector when property changes
    propertySelector.addEventListener('change', function() {
        const propertyId = this.value;
        
        // Reset analysis selector
        analysisSelector.innerHTML = '<option value="">-- Select Analysis --</option>';
        analysisSelector.disabled = true;
        
        // Reset generate button
        generateReportBtn.disabled = true;
        
        // Hide comparison preview
        comparisonPreview.classList.add('d-none');
        
        if (propertyId) {
            // Fetch analyses for the selected property
            fetch(`/api/property-financials/compare/${propertyId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.comparison && data.comparison.available_analyses) {
                        const analyses = data.comparison.available_analyses;
                        
                        // Add analyses to selector
                        analyses.forEach(analysis => {
                            const option = document.createElement('option');
                            option.value = analysis.id;
                            option.textContent = analysis.name;
                            analysisSelector.appendChild(option);
                        });
                        
                        // Enable analysis selector
                        analysisSelector.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error fetching analyses:', error);
                });
        }
    });
    
    // Update generate button when analysis changes
    analysisSelector.addEventListener('change', function() {
        const analysisId = this.value;
        const propertyId = propertySelector.value;
        
        // Reset generate button
        generateReportBtn.disabled = !analysisId;
        
        // Hide comparison preview
        comparisonPreview.classList.add('d-none');
        
        if (propertyId && analysisId) {
            // Fetch comparison data for preview
            fetch(`/api/property-financials/compare/${propertyId}?analysis_id=${analysisId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.comparison) {
                        updateComparisonPreview(data.comparison);
                        comparisonPreview.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error fetching comparison data:', error);
                });
        }
    });
    
    // Generate report when button is clicked
    generateReportBtn.addEventListener('click', function() {
        const propertyId = propertySelector.value;
        const analysisId = analysisSelector.value;
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (propertyId && analysisId) {
            // Build URL with query parameters
            let url = `/api/property-financials/kpi-report/${propertyId}?analysis_id=${analysisId}`;
            
            if (startDate) {
                url += `&start_date=${startDate}`;
            }
            
            if (endDate) {
                url += `&end_date=${endDate}`;
            }
            
            // Open report in new tab
            window.open(url, '_blank');
        }
    });
    
    // Update comparison preview with data
    function updateComparisonPreview(comparison) {
        const actual = comparison.actual_metrics;
        const projected = comparison.projected_metrics;
        
        // Income & Expenses
        document.getElementById('projected-income').textContent = formatCurrency(parseFloat(projected.total_income.monthly));
        document.getElementById('actual-income').textContent = formatCurrency(parseFloat(actual.total_income.monthly));
        document.getElementById('income-variance').textContent = formatVariance(comparison.income.monthly_variance, comparison.income.monthly_variance_percentage);
        
        document.getElementById('projected-expenses').textContent = formatCurrency(parseFloat(projected.total_expenses.monthly));
        document.getElementById('actual-expenses').textContent = formatCurrency(parseFloat(actual.total_expenses.monthly));
        document.getElementById('expenses-variance').textContent = formatVariance(comparison.expenses.monthly_variance, comparison.expenses.monthly_variance_percentage);
        
        // NOI & Cash Flow
        document.getElementById('projected-noi').textContent = formatCurrency(parseFloat(projected.net_operating_income.monthly));
        document.getElementById('actual-noi').textContent = formatCurrency(parseFloat(actual.net_operating_income.monthly));
        document.getElementById('noi-variance').textContent = formatVariance(comparison.noi.monthly_variance, comparison.noi.monthly_variance_percentage);
        
        document.getElementById('projected-cashflow').textContent = formatCurrency(parseFloat(projected.cash_flow.monthly));
        document.getElementById('actual-cashflow').textContent = formatCurrency(parseFloat(actual.cash_flow.monthly));
        document.getElementById('cashflow-variance').textContent = formatVariance(comparison.cash_flow.monthly_variance, comparison.cash_flow.monthly_variance_percentage);
        
        // Investment Metrics
        if (comparison.cap_rate) {
            document.getElementById('projected-cap-rate').textContent = formatPercentage(parseFloat(projected.cap_rate));
            document.getElementById('actual-cap-rate').textContent = formatPercentage(parseFloat(actual.cap_rate));
            document.getElementById('cap-rate-variance').textContent = formatVariancePercent(comparison.cap_rate.variance, comparison.cap_rate.variance_percentage);
            document.getElementById('cap-rate-status').textContent = formatStatus(comparison.cap_rate.is_better_than_projected);
            document.getElementById('cap-rate-status').className = comparison.cap_rate.is_better_than_projected ? 'text-success' : 'text-danger';
        }
        
        if (comparison.cash_on_cash_return) {
            document.getElementById('projected-coc').textContent = formatPercentage(parseFloat(projected.cash_on_cash_return));
            document.getElementById('actual-coc').textContent = formatPercentage(parseFloat(actual.cash_on_cash_return));
            document.getElementById('coc-variance').textContent = formatVariancePercent(comparison.cash_on_cash_return.variance, comparison.cash_on_cash_return.variance_percentage);
            document.getElementById('coc-status').textContent = formatStatus(comparison.cash_on_cash_return.is_better_than_projected);
            document.getElementById('coc-status').className = comparison.cash_on_cash_return.is_better_than_projected ? 'text-success' : 'text-danger';
        }
        
        if (comparison.debt_service_coverage_ratio) {
            document.getElementById('projected-dscr').textContent = formatDecimal(parseFloat(projected.debt_service_coverage_ratio));
            document.getElementById('actual-dscr').textContent = formatDecimal(parseFloat(actual.debt_service_coverage_ratio));
            document.getElementById('dscr-variance').textContent = formatVarianceDecimal(comparison.debt_service_coverage_ratio.variance, comparison.debt_service_coverage_ratio.variance_percentage);
            document.getElementById('dscr-status').textContent = formatStatus(comparison.debt_service_coverage_ratio.is_better_than_projected);
            document.getElementById('dscr-status').className = comparison.debt_service_coverage_ratio.is_better_than_projected ? 'text-success' : 'text-danger';
        }
    }
    
    // Format variance for currency values
    function formatVariance(variance, percentage) {
        const varValue = parseFloat(variance);
        const pctValue = parseFloat(percentage);
        
        return `${formatCurrency(varValue)} (${pctValue.toFixed(2)}%)`;
    }
    
    // Format variance for percentage values
    function formatVariancePercent(variance, percentage) {
        const varValue = parseFloat(variance);
        const pctValue = parseFloat(percentage);
        
        return `${varValue.toFixed(2)}% (${pctValue.toFixed(2)}%)`;
    }
    
    // Format variance for decimal values
    function formatVarianceDecimal(variance, percentage) {
        const varValue = parseFloat(variance);
        const pctValue = parseFloat(percentage);
        
        return `${varValue.toFixed(2)} (${pctValue.toFixed(2)}%)`;
    }
    
    // Format status
    function formatStatus(isBetter) {
        return isBetter ? 'FAVORABLE' : 'UNFAVORABLE';
    }
});
</script>
{% endblock %}
